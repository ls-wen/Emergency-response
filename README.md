# Emergency-response
应急响应实战与恶意病毒样本分析 电子数据取证指南——持续更新 求star

![image](https://github.com/shanshanerxi/Emergency-response/assets/126464165/d8c88fb6-8987-4633-909a-390615198ab6)
![image](https://github.com/shanshanerxi/Emergency-response/assets/126464165/732ad8f7-549d-4531-aeaf-9c34cc4c7d19)
![image](https://github.com/shanshanerxi/Emergency-response/assets/126464165/5798719e-fa14-4bee-8582-2f933de4ae37)
## 应急响应
事件分类

有害程序事件（僵木蠕） 网络攻击事件（非法渗透） 信息破坏事件（泄露篡改）    信息内容安全（敏感舆论）  设备设施故障（基础设施)  灾害性事件(不可抗力) 其他

影响评估

信息系统的重要程度  系统损失 社会影响   根据三要素分为四等级评判

实施 PER模型  根据预先准备进行排查遏制扩散，根除加固恢复进行追踪

### 应急响应需要干嘛

应急响应关键点在于及时阻止危害恢复业务系统，并且在尽可能全面收集信息 认真侦查辨别情况下，进行溯源取证还原攻击者路径，修复加固风险点，确保同场景攻击不会再出现，是否反制，根据信息和需求来决定

### 应急响应需要具备的技能栈

一位合格的应急响应工程师所具备的素养，知攻善放，攻 复现攻击者路径想法。防 能够进行主被动防御， 细分一点来说在于 样本分析能力（常见病毒理解和二进制逆向分析），日志（web 服务器 系统 数据库 设备），流量（漏洞与工具，东西南北，异常流量 外连 可疑通信  网络活动），系统排查（账号 启动项 计划任务   进程  网络连接），取证（活死取证 实时对抗核心要素），网络架构的理解能力（判断危害范围，以及怎么快速去规划应急策略），并且保持终身学习和实时对抗的心态（攻防的核心是对抗，对抗的核心是两端的成本较量 （技术，经济））

根据博弈论的纳什均衡来说，在没有第三方因素影响之下，对抗双方都会做出倾向于收益最大化的选择，尽管不符合社会常理与道德，而判断一个应急响应工程师水平高低关键在于如何在特定规则和时间约束下，精准解读并高效运用掌握信息，策划并执行最具实效的战术策略，从而确保最大限度的投资回报

### 应急响应所面对的场景

常见的病毒场景  僵木蠕，勒索，挖矿，劫持，数据 甚至这些常见的病毒还可进行组合， 僵尸木马与挖矿结合，打造赛博矿场，蠕虫与ARP劫持结合，断掉业务的同时，还进行不断的繁殖，并进行信息的窃取，木马与勒索的结合，不出网的场景下 依然能够进行投递 而非钓鱼,这些漏洞因为他们具有高额度的回报，并且效率高 因此屡见不鲜

但已知并不可怕，害怕的是未知，如APT 如何去防范一个APT，怎么去从NTA南北东西流量，以及全设备日志，以及业务异常行为中结合威胁情报，找出蛛丝马迹 进行威胁狩猎出攻击者，这是最难的，也是应急响应高阶的能力



## Windows系统应急

### 系统排查

​	msinfo32查看系统信息 对目前信息进行排查 任务 服务 启动项  或systeminfo

1. **检查网络连接异常端口和进程**

   1. 任务管理器

   2. 使用`netstat -ano`命令检查端口连接情况，寻找可疑连接。

   3. 利用`tasklist`命令和Process Explorer等工具检查进程信息，关注无签名或异常进程。

      1. 针对DLL tasklist /m     守护进程则PowerShell   wmic process   

         

2. **可疑账户**：

   ​		火绒安全软件、360杀毒。


1. **病毒动态信息源**：
   - CVERC、微步在线威胁情报社区、火绒安全论坛、爱毒霸社区、腾讯电脑管家。
2. **在线病毒扫描网站**：
   - Virscan、腾讯哈勃分析系统、Jotti恶意软件扫描系统、Scanvir。
3. **WEBSHELL查杀工具**：
   - D盾_Web查杀、河马webshell查杀、深信服Webshell检测工具、Safe3。 



## Linux系统应急

### 系统排查

1. **检查异常端口 网络连接和进程**：

   - 使用`netstat`  -antp可查网络连接，可疑端口、 PS aux 查PID进程   diss 12 查隐藏进程   lsof -p 查看进程打开的文件  

   - 来自互联网ip的非正常端口都是可疑连接 知名端口 0-1023 和一些特殊端口 先挂起查杀守护进程 再查宿主   top查挖矿

   - 攻击可通过inux-inject或Cymothoa工具实现进程隐藏，让在`ps`、`top`命令不可见

   - 端口复用是指在同一端口上运行多个服务或应用，通过SSLH或IPTables将SSH服务配置监听在HTTPS端口上，SSH流量就会通过加密的HTTPS通道传输，从而实现SSH端口的隐藏，使得SSH登录不会被`w`、`who`、`last`等命令检测到，实现隐身登录 NTA

2. **可疑用户**：

   ​	格式:用户名:密码:用户ID:组ID:用户说明:家目录:登录后shell

   - 检查`/etc/passwd`和`/etc/shadow`文件，确认用户信息和密码状态。 可加上more 排查新增用户 

   - 查看UID为0，能够登录和远程登录   存在sudo权限的账号，特权账号（看系统的配置和策略，比如sysadmin 空口令） 最后登录lastlog

   - 禁用或删除不必要的账号

     使用`chattr`命令可以改变文件的属性，例如加上`i`（immutable）属性可以使文件不可更改，即使root用户也无法删除或修改，这可以作为一种隐藏手段   恢复到单用户模式对他进行清除

3. **历史命令**：

   - history查看用户的历史命令记录，特别是root用户的命令历史cat /root/.bash_history	   wget排查远控  内网ssh scp(传输) 
   - 在Linux中，可以通过shell暂时关闭历史记录功能 比如unset HISTFILE，或者从`.bash_history`文件中删除特定的命令记录，备份

4. **检查异常文件**：

   - 检查`/tmp`等敏感目录下的文件，以及stat查看创建时间异常的文件   find / -ctime查看新增文件 根据时间反推变更的时间  

   - 特殊权限文件 ps默认644 最小444   shadow默认600 最小 400     

   - 在Linux中，文件名以点（`..`）开头的文件或目录默认是隐藏的，不会在常规的`ls`命令输出中显示。要查看这些隐藏文件，需要使用`ls -al`命令，如果系统命令被更改可用ls -alt /bin查看最近命令修改   ls -alh /bin 文件大小

     攻击者用`touch`命令来修改文件的时间戳，使其与正常文件一致，从而避免被发现。 stat

5. **检查开机和服务启动项**：

   - 检查`/etc/rc.local`、`/etc/rc.d/rc[0~6].d`等启动脚本和链接。S开头为自启  K是脚本  more排查  S100ssh是软连接（恶意隐藏 绕过限制路径 提权）
   - **检查服务自启动**：
     1. 服务启动有三种方式 利用开机自启动 /etc/re.d/rc.local   命令ntsysv管理启动    命令chkconfig 级别2-5
     2. 使用`chkconfig --list` 或`systemctl`命令查看服务的启动状态   grep crond 查看当前服务  服务有0-6等级 1为单用户

6. **检查定时任务和系统日志**：

   - 查看`crontab`、`/etc/crontab`、`/etc/cron.d/*`等计划任务。 crontab -l  列出详细内容
   - 分析`/var/log/`目录下的日志文件，如`secure`、`messages`、`lastlog`等。

   

   

### 工具篇

1. **Rootkit查杀**：
   - 使用`chkrootkit`和`rkhunter`检测和移除rootkit。
2. **病毒查杀**：
   - 使用`Clamav`进行病毒扫描和查杀。
3. **Webshell查杀**：
   - 使用河马webshell查杀工具和深信服Webshell检测工具检测和清除webshell。
4. **RPM检查**：
   - 使用`rpm -Va`检查系统文件的完整性。
5. **Linux安全检查脚本**：
   - 使用Github上的安全检查脚本，如`GScan`、`security_check`和`linux`进行系统安全检查。





## 后门检查

1. 文件MD5校验

利用MD5或其他哈希算法来计算文件的哈希值，可以快速检测文件是否被篡改。通过比较当前文件的哈希值与原始值，可以发现文件是否发生变化。

2. diff命令

在Linux系统中，`diff`命令可以用来比较两个文件或文件夹的差异。这个命令可以递归地比较目录结构，并以易于理解的格式展示差异

3. 版本控制工具

使用版本控制系统（如Git）可以帮助追踪文件的历史变更。通过查看提交历史和文件的变更，可以发现代码何时以及如何被修改。

4. 文件对比工具

专业的文件对比工具，如Beyond Compare和WinMerge，提供了强大的文件和文件夹比较功能。这些工具可以高亮显示差异，并提供直观的用户界面来查看和处理这些差异。

Beyond Compare

- 下载地址：http://www.scootersoftware.com/download.php![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQ4jY2TPWhTURTH/+e8l7QNJg0qCJpCSdEnONTFDk5udfILs9mS6iJYpI4VnURXUcRJrFG3gm3tXLpIxaUUIVA/iLRJayQ2Nk1q7cu99zjUF/JhQv7jOff/O+fcwyERAQAQEaoVjsdOirgP93L+W5svJpeq8xVfPWD/yPkepekBWbjETl8nM0h9XtkRV72xLbmdn5hJ/xdw4OaVkC6U7oBwg6MRH0d7fGTbQDoLIYKUXa2/rO5C6SdWOHh/4/HrLQCwvZZUoZi2Dh/ysdPbRZ0dNeOQCMj2WXTiaMCUtsdUKn0dQHcNAEZCVr+DViJjYAW6/NqI34txS0eVIqEwRgfONMTbApyORDE3PIbF9dX2AKPHTyESCFbMExeGMTL9EguZVHuAxY3vmBscwtkjfS3NTQELuQzi72bwaGAQ8elEUzNQtQUiLsmf3X3eCt/n1uBMPQUy2bqSDCIuNXQgjHnJ5kzTUt47rUQY8w0AG2ZcLX/bkc2t5m5mlJdTv22Y8QZAPjGbBPHl8oePRb2yruu9BjBu8msRGrF8YjZZGb3+mA5ePee4ip9xoKOfj/UGSRuYtR/b+ldxyW/paz+fv/0EtLhGT91DF2NgubtXnu4VXk1N1vzFP99f037PUFbu4yIAAAAASUVORK5CYII=)
- 功能：对比文件夹和文件，以颜色标示差异内容。

WinMerge

- 下载地址：https://winmerge.org/downloads/![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQ4jY2TPWhTURTH/+e8l7QNJg0qCJpCSdEnONTFDk5udfILs9mS6iJYpI4VnURXUcRJrFG3gm3tXLpIxaUUIVA/iLRJayQ2Nk1q7cu99zjUF/JhQv7jOff/O+fcwyERAQAQEaoVjsdOirgP93L+W5svJpeq8xVfPWD/yPkepekBWbjETl8nM0h9XtkRV72xLbmdn5hJ/xdw4OaVkC6U7oBwg6MRH0d7fGTbQDoLIYKUXa2/rO5C6SdWOHh/4/HrLQCwvZZUoZi2Dh/ysdPbRZ0dNeOQCMj2WXTiaMCUtsdUKn0dQHcNAEZCVr+DViJjYAW6/NqI34txS0eVIqEwRgfONMTbApyORDE3PIbF9dX2AKPHTyESCFbMExeGMTL9EguZVHuAxY3vmBscwtkjfS3NTQELuQzi72bwaGAQ8elEUzNQtQUiLsmf3X3eCt/n1uBMPQUy2bqSDCIuNXQgjHnJ5kzTUt47rUQY8w0AG2ZcLX/bkc2t5m5mlJdTv22Y8QZAPjGbBPHl8oePRb2yruu9BjBu8msRGrF8YjZZGb3+mA5ePee4ip9xoKOfj/UGSRuYtR/b+ldxyW/paz+fv/0EtLhGT91DF2NgubtXnu4VXk1N1vzFP99f037PUFbu4yIAAAAASUVORK5CYII=)
- 功能：比较文件夹和文件，以可视文本格式显示差异



**MSF权限维持**

- **Persistence模块**: Metasploit 提供了多种方式实现权限维持，例如通过修改目标主机的启动项来保证每次系统启动或者用户登录时后门程序自动运行。
  - `-U` 参数用于在用户登录时启动后门，在HKCU相关注册表键值下添加启动项。
  - `-X` 参数试图在系统启动时启动后门，但由于权限限制，如果当前权限不足，此方法可能失败。
  - `-S` 参数则是创建一个系统级别的服务，使得后门程序能以SYSTEM权限运行。
- **Metsvc模块**: 另一种方法是通过创建一个名为"Metsvc"的服务，这样即使目标主机重启，服务也会自动启动并等待连接。

**Empire权限维持**

- Empire提供了多种权限维持技术，包括但不限于通过注册表、计划任务和服务等机制。
  - **Registry** 类型的后门可在注册表启动项下添加启动指令，确保每次系统启动时执行。
  - **Schtasks** 类型则利用Windows计划任务功能，设置特定时间点执行后门程序。
  - **WMI** 方法利用Windows Management Instrumentation服务，可以设置自启动事件。

**Cobalt Strike权限维持**

- 使用Cobalt Strike时，可以通过无文件自启动后门或创建服务等方式维持权限。
  - **Web Drive-by Attack**：通过Scripted Web Delivery生成powershell后门脚本，然后利用目标主机下载并执行。
  - **服务自启动后门**：通过`sc`命令创建服务，使其在系统启动时执行指定命令来启动后门。
  - **注册表自启动**：在HKLM或HKCU下的`Run`键值下添加后门程序的启动指令，使得系统启动时自动执行。

除了上述提到的几个注册表启动项位置外，键值下设置自启动项以实现权限维持：

- `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`



## 日志分析

### Windows

​	**分析技巧 看什么时候登录 什么时候注销 确定时间线    特别是系统日志**  分析工具 Log Parser LIzard  图形化分析工具 sql语句直接查询使用

- Windows事件日志简介 主要在/System32/config/下

  - **系统日志**：记录操作系统组件产生的事件，如驱动程序错误、系统组件崩溃等。

  - **应用程序日志**：包含应用程序或系统程序记录的事件，如程序运行错误或数据库错误。

  - **安全日志**：记录安全审计事件，包括登录尝试、对象访问、特权使用

    

  审核策略与事件查看器  记录 硬件变化像驱动安装   网络连接    USB插入取出	用户行为  RDP

  ​    **事件查看器**：是Windows自带的工具，用于查看和分析系统日志。可以通过“开始”菜单或运行`eventvwr.msc`命令来打开。

  - **审核策略**：可以通过“本地安全策略”或注册表设置来配置审核策略，以便记录安全相关的事件，分为警告 错误 成功审核 失败审核  又分为  系统日志  应用日志 安全日志

  - 事件ID 20创建用户  24 成功  25失败  34注销   47用户启动的注销 72 管理员而每个登录事件都会标记一个登录类型 2 本地登录  3连接到网络如共享文件夹打印机   4计划任务启动 ，5服务下特定用户的登录   7锁屏解锁   8密码在网络上是明文	9凭证登录  10远程登录   11域用户登录又没有域控，比如账号admin 密码xxx  计算机为xxx  事件ID 4624   登录类型10   RDP远程登录

    

  

  日志分析工具

  - **Log Parser**：微软提供的命令行工具，可以分析多种格式的日志文件，包括系统事件日志。支持SQL查询语句，可以导出和可视化分析结果。
    - 下载地址：https://www.microsoft.com/en-us/download/details.aspx?id=24659
  - **Log Parser Lizard**：提供了图形用户界面，简化了Log Parser的使用。不需要复杂的命令行操作，适合不熟悉命令行的用户。
    - 下载地址：http://www.lizard-labs.com/log_parser_lizard.aspx![img](data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAACXBIWXMAAAsSAAALEgHS3X78AAAB3ElEQVQ4jY2TPWhTURTH/+e8l7QNJg0qCJpCSdEnONTFDk5udfILs9mS6iJYpI4VnURXUcRJrFG3gm3tXLpIxaUUIVA/iLRJayQ2Nk1q7cu99zjUF/JhQv7jOff/O+fcwyERAQAQEaoVjsdOirgP93L+W5svJpeq8xVfPWD/yPkepekBWbjETl8nM0h9XtkRV72xLbmdn5hJ/xdw4OaVkC6U7oBwg6MRH0d7fGTbQDoLIYKUXa2/rO5C6SdWOHh/4/HrLQCwvZZUoZi2Dh/ysdPbRZ0dNeOQCMj2WXTiaMCUtsdUKn0dQHcNAEZCVr+DViJjYAW6/NqI34txS0eVIqEwRgfONMTbApyORDE3PIbF9dX2AKPHTyESCFbMExeGMTL9EguZVHuAxY3vmBscwtkjfS3NTQELuQzi72bwaGAQ8elEUzNQtQUiLsmf3X3eCt/n1uBMPQUy2bqSDCIuNXQgjHnJ5kzTUt47rUQY8w0AG2ZcLX/bkc2t5m5mlJdTv22Y8QZAPjGbBPHl8oePRb2yruu9BjBu8msRGrF8YjZZGb3+mA5ePee4ip9xoKOfj/UGSRuYtR/b+ldxyW/paz+fv/0EtLhGT91DF2NgubtXnu4VXk1N1vzFP99f037PUFbu4yIAAAAASUVORK5CYII=)
  - **Event Log Explorer**：第三方工具，提供了强大的过滤和分析功能，可以快速从大量日志中提取有用信息。
    - 下载地址：https://event-log-explorer.en.softonic.com

### liunx

**日志守护进程是syslog  /etc下面 任何希望生成日志的程序都可以向守护进程发信息，日志优先级从0到1 越小越不安全 3以下就为威胁事件**  

**Linux系统日志通常存储在`/var/log/`目录下，不同类型的日志文件记录了系统的不同方面的信息。**

- **`cron`：记录了系统定时任务的执行情况。**
- `dmesg`：记录了系统启动时内核的自检信息。
- `maillog`：记录了邮件服务的相关日志。
- `**message`：记录了系统大部分重要信息，是排查问题的主要日志文件。**
- **`btmp`：记录了失败的登录尝试。**
- `lastlog`：记录了所有用户的最后一次登录时间。
- **`wtmp`：记录了所有用户的登录和注销信息，以及系统的启动和关闭事件。**
- `utmp`：记录了当前登录的用户信息。
- `secure`：记录了与安全相关的事件，如SSH登录、用户切换、sudo操作等
- **不能直接查看的则为二进制，得用last查看**

#### 日志分析技巧

1. **常用的Shell命令**：
   - `find`、`grep`、`awk`、`sed`命令是分析日志时常用的工具。
   - 使用`grep -C`、`grep -B`、`grep -A`来查看日志上下文信息。
   - 使用`grep -rn`递归查找包含特定字符串的文件。
   - 使用`head`和`tail`来查看文件的指定行范围。
2. **日志分析实例**：
   - **登录失败分析**：使用`grep "Failed password"`来查找失败的登录尝试，并提取相关信息。
   - **登录成功分析**：使用`grep "Accepted "`来查找成功的SSH登录事件，并提取登录的日期、用户名和IP地址。
   - **用户管理操作**：通过`grep "useradd"`和`grep "userdel"`来追踪用户创建和删除的操作。
   - **命令执行记录**：通过分析用户的`.bash_history`文件来查看用户执行过的命令。
3. **Yum日志分析**：
   - `yum.log`记录了软件包的安装、更新和卸载操作。
   - 通过查看`yum.log`可以追踪软件包的变化历史，有助于发现未经授权的软件安装或更新



### **Web** 

主要为对web页面的访问操作行为

定位时间段，统计分析后关注访问模式、错误和异常、资源利用、用户代理、会话行为、安全事件、流量来源、数据泄露迹象以及配置和兼容性问题

#### Notepad++分析日志

shell命令分析 Windows下需安装Cygwin     

命令grep awk  提取的时候加个sort -nr排序 保证日志的原本     uniq重复出现的列 暴力破解

grep 筛选 比如 grep 200  筛选日志中为200的状态码

awk 提取特定关键    awk '{print $1}' access.log   打印出所有IP地址

日志分析案例：

- 当面对代理服务器场景时，虽然日志仅记录了代理IP而非客户端IP，可通过浏览器指纹追踪攻击者路径。
- 分析攻击者的行为轨迹，确定他们是如何通过上传图片木马来绕过安全防护措施，进而发现并修复文件上传漏洞和越权访问漏洞。



### 设备

####  **网络/安全设备**

主要用于 链路故障排查 硬件排查  ARP攻击   通过这些设备配置可以快速了解当前网络拓扑结构  如通过路由表掌握数据传输路径绘制拓扑 show ip route 

如发现内网ip攻击外网业务系统，通过NAT地址转换表可以快速锁定  show ip nat translations

查看接口分析MAC地址 传输模式  流量  结合ARP（相互通信） 以及vlan（未授权访问 网段）  ，这样可以快速分析受影响的设备 网段 

查看ACL show ip access-lists 



#### 经典设备

防火墙 三代为状态感知 四代为UTM  五代为下一代 如雷池 应用层全面保护  主要功能 防病毒 VPN 入侵检测和负责均衡过滤 授权验证

waf 事前可以进行web应用漏洞扫描，事中入侵检测  事后诊断  主要为访问日志（C/S的所有） 攻击日志 DDOS 防篡改

IPS串联防御 IDS旁路分析在交换机上拿流量镜像  技术为异常检测和误用检测  异常 通过统计算法聚合正常流量对不正常的进行防御     误用 逆向思维 先定义异常  未知的都是正常的      异常方法在于并非所有入侵都是异常的  误用在于 无法针对未知的攻击 且两者误报都高 比如设备串联误报  如 时间 日志类型  日志级别 详细信息   策略 封禁        现在IDS和IPS可对常规工具进行阻止



#### 抗APT

APT 精心 长期潜伏   持续渗透   

传统设备无法防APT的原因 

IPS无法区分普通攻击和APT  

漏洞库质量数量不够和DPI（深度报文监测）需要控制大小 导致漏报

审计对象颗粒度 不同产品审计不一样 无法统一关联溯源 比如防火墙的外联和内网的入侵无法进行关联

完整的APT检测包括 威胁情报  流量传感器（检测 匹配威胁情报  文件还原 数据采集）  沙箱（行为分析图） 分析平台（态势感知 场景化分析）  每一个都在前者的基础上进行联动

威胁情报 攻击者相关  漏洞情报  资产情报 内部的IT业务资产和人信息

态势感知 外部感知 事件和资产风险感知  分为 威胁视图  受害资产分析  攻击者分析 威胁分析  主要作用  以攻击链的方式自动重现攻击过程

NGSOC 探针采集 数据分析 给服务引擎 最终联动业务进行SOC

攻击和行为可用机器学习来判断 因为单一的黑名单无法自主优化 但机器学习可以进行自主学习和泛化 多种算法结合 如K近领 决策树 随机森林  朴素贝叶斯 逻辑回归  推荐书籍：web安全之机器学习入门/深度学习实战/强化学习与gan     



### **MSSQL**

​	mysql得登录

- 在MSSQL服务器上，要启用详细的登录日志记录，包括成功和失败的登录尝试。
- 使用SQL Server Management Studio可查看和过滤SQL Server日志，而SQL Server Profiler有助于监控SQL执行性能和语句问题。
- 通过分析日志，可以检测到异常登录行为，例如弱口令尝试和成功登录记录。
- 在遭受SQL注入攻击后，可以通过检查数据库中新创建的表、存储过程（如xp_cmdshell）的状态变化以及web服务器日志等途径寻找攻击痕迹

### 其他日志

IIS apache （access.log）有四个，nginx在/usr/local下  tomcat 在logs 下  webLogic有三种access server domainlog    Redis看配置





## 流量分析

采用自动化和机器算法 深度包检测，先了解正常的流量模式，去除误报后实时监控异常流量并与其他安全事件与日志 历史数据结合对比，及时响应

异常的流量（与正常流量不符合，满足恶意特征，异常行为（频繁登录 半夜访问  多次错误））

### NetFlow

NetFlow技术 思科首创，最开始用于设备加速处理数据，经过演变 现由网络设备中专有的ASIC芯片实现，成为目前IP/MPLS（多协议标签交换 适用于SDN服务导向架构）流量分析 统计和计费的标准

NetFlow 是基于流的流量分析技术，每条流相当于一次连接或会话  只取报文中的重要字段 与之相反的是 全流量分析

#### 与SNMP区别

SNMP面向设备 以物理接口进行统计 免费

NetFlow面向流量关注session会话，数据丰富能适应高端网络，但收费 且不全面

NetFlow关注5W1H  谁   在这个时间  通过路径  在应用做了  是否正常的行为  产生了多少流量数据包



#### 关注点

异常流量分析 种类 流向 后果  类型 地址端口   IP报文一般有 生存时间 协议  源目的  首部校验和  服务类型 标志



### 全流量分析

如无法查看攻击者的具体命令

重点非标准端口  主机发生异常数据  恶意畸形的帧    用户

工具wireshark  时间——过滤—ip—协议端口——统计——分析 看带宽——追踪流进行还原（太大时候可进行分割）——导出特定字段

#### 关注点

web分析 http.request.method  筛选所有请求内容

arp分析   DNS分析 统计 I/O表  端点统计（分析ip异常行为 外连 异常流量等）  ip.dst_host eq 指定ip地址 分析病毒

#### 工具

**Wireshark**：可以获取网络封包详细显示,WinPcap为接口，直接与网卡进行数据报文交换。

**NetworkMiner**：网络流量取证，文件提取，图片提取、主机识别，凭据提取，参数提取

**TCPView**：网络连接详情进程、协议、进程、源目地址、源目端口、连接状态

**注意**：定期审查和更新流量分析策略和工具，以适应不断变化的网络环境和新的威胁。这包括更新签名数据库、威胁情报和分析规则。



## 恶意代码分析

### Windows

工具Process Explorer 查看进程树    不一定关闭主进程 子进程就会被关闭，当你关闭Rolan主进程时，操作系统通常不会自动终止由它启动的子进程，因为每个进程都是独立管理的。这是基于操作系统的进程管理机制，其中父进程（如Rolan）通常只负责创建子进程，而不负责管理子进程的生命周期，要确保子随父，得实现进程信号的机制

**内核是操作系统基础部分，为应用程序提供对计算机硬件安全访问的软件**

Windows的窗口程序是基于消息 由事件驱动的  以便响应用户的输入和系统事件 提供交互性和动态行为  而捕获消息得使用钩子  HOOK 

HOOK分全局和局部，局部针对某个线程，全局则实现 Windows消息的拦截 处理 监控 作用于整个系统有关消息的应用，需要使用DLL以实现响应的钩子函数  钩子可分 键盘 鼠标 外壳shell  日志 窗口，因为这些使其成为恶意程序常用对象  比如利用钩子绕过杀毒 窃取数据 记录键盘

**排查工具 Windows PCHunter   ，其他排查进入正常应急响应流程**		

### liunx

**和前文一样 Chkrootkit 检查后门 木马 rookit	  系统命令是否正常 登录日志    复查工具可用Rootkit Hunter**



### 发展历程

1971诞生  90多态病毒（每次允许都会变换表现形式）  95宏病毒      2000爱虫  01灰鸽子远控   03 Slammer和冲击波蠕虫 

 07熊猫烧香 自传播感染硬盘进行破坏并且删除gho系统备份镜象  10震网 第一个定位真实世界的病毒蠕虫APT 核电站 水坝 国家电网   

 17永恒之蓝勒索 影子经纪人公布 同年被改为WannaCry勒索病毒 

**发展特征：简单到内核复杂病毒  主动传播和破坏性大的蠕虫  传播机制和生存技术研究不断进化** 

**病毒通常不会作为一个可执行程序运行，隐蔽 依赖合法的宿主程序 特定的条件激活和传播（附件 软件漏洞  特定的环境）**



### 感染方式

伴侣感染：用户执行源程序 会激活病毒程序 通常不修改目标可执行文件 但会隐藏com文件 com exe bat  优先权com最高

改写感染：改写宿主部分代码来感染可执行文件  狸猫换"太子"

前置感染：前入  自身代码插入感染程序头部   	  附加感染：后入  插尾部

引导扇区：操作系统引导模板放在固定的物理位置，病毒占据，执行后控制权再给引导区  这样系统看似无毒 实则毒发   环境为BIOS中断服务

文档文件：宏病毒，宏是将一系列word命令和指令结合，重复的工作就可以用宏执行，但word normal.dot定义 启动word 就运行normal.dot （里面有宏）,且这个模板是word默认通用  广为被宏病毒利用

**病毒的传播：人的参与是主要，网络是其次，设备再次**



### 病毒的启动



#### **DLL**  

​	1.单独编写通过rundll32.exe启动 较差，

​	2.替换系统合法的DLL 遇见请求DLL时转发原来的dll  

​	3,远程注入DLL 用一个exe将病毒DLL加载到系统进程如explorer.exe运行）

#### 注册表

​	1.RUN注册表  2.Load注册表  3.Userinit注册表   4.映像劫持Image File Execution Options下写入病毒路径



#### 服务启动（远控较多）

​	services.msc发现服务描述是空白或英文的 多半是病毒

​	将自身创建为隐藏的服务，通过挂钩系统本地调用实现隐藏，查杀工具Knlsc



#### 其他

启动项（少见 u盘较多）    捆绑（绕过程序CRC验证） 

感染可执行文件 代码插入前后或者中间  但别破坏文件本身

利用SYS：加载SYS驱动文件调用Hook API函数 隐藏自身 绕过主动防御

写入硬盘MBR:引导扇区由主引导记录MBR和硬盘分区表组成，MBR先判断被标记的活动分区，再去读取那个分区的启动区，进行运行



### 病毒的隐藏与自我保护

#### IFEO 

早期的NT heap堆太垃圾，本意是为了更好的动态内存分配兼容性引入IFEO 作为注册表键，允许用户配置特定文件的执行选项，而恶意软件修改后导致 DLL劫持 改变程序堆管理 以较低权限运行绕过检测   延迟程序的启动



#### 进程守护

多个进程相互保护 文件关联，不太病毒进程会检测对方是否被擦除 是 则重新生成对面  而任务管理器只能结束一个进程    得查找相关联的守护进程



#### 免杀技术

antiAV 反杀毒技术  加壳 花指令 混淆 特征  DLL 



### 木马常用技术

本质是一种C/S网络程序， 专注协议 HTTP UDP ICMP 破皮

#### NTFS交换数据流技术  

文件存在多个文件流，非文件流寄宿在主文件流下，一般只显示主，从用户的角度来说 无法观察到隐藏流，Windows资源管理器也不行，木马利用这个特性在ADS（非主流）进行隐藏

#### 远程线程插入

将代码插入运行进程中，通过在另一个进程创建远程线程进入内存地址空间，拥有和进程一样的权限 就可在内部启用DLL

#### 端口复用SocketAPI

在winsock实现对于服务器绑定是可以多重的，谁的指定明确则包给谁，没有权限之分，低级权限可以重绑定高级权限 进行提权 服务劫持 中间人攻击，木马也可以借此进行隐藏

#### 多线程保护

Windows引入了一进程多线程，三线程技术，一主一监控一守护，主管远控，监控检测主是否被清除和运行，守护注入到其他的可执行文件内，主没再创主 并提供数据

#### 反向连接

防火墙对外不对内



### 木马之王Rootkit

root 至高权限，kit工具实现，Rootkit 获得至高权限并能在计算机中隐藏的恶意工具技术

最早用于unix操作系统的工具集，入侵者利用他隐藏痕迹，程序在植入系统后 Rootkis将指定程序隐藏，包括任意过程 文件夹  注册码，就像金钟罩和铁布衫 很难清除

使用技术

Hooking

DLL注入

直接内核对象操纵

最高级的Rootkit技术，修改内核结构 绕过内核对象管理器来避免访问检查







### webshell 恶意代码分析技术

黑白名单检测 工具Ssdeep模糊哈希算法，以样本库为基础   相似度接近则杀除，特点：已知或变形查杀高 但新型或不以文件形式的低

静态检测：关键词和高危函数比如eval，fopen udf.dll      特点：检测明文快 但误报高 变形加密无法检测

文件时间检测：检测文件创建和修改时间，针对插入页面的webshell和新增的webshell有效果     虽有奇效但误报高 可通过修改时间绕过      

图片路径分析：文件上传检测   辅助角色

动态检测 

通过动态特征来确认 如执行命令有进程，通信一般为http，检测 文件  目录  数据库  扫描 注册表  打开应用程序  执行系统信息 ipconfig

日志检测

中间件分析

关注 中间件和数访问文件分析：比如少量ip进行访问 一段时间内总体访问量较少，保留http状态码200的日志，排除静态页面 通过指纹排查扫描器日志，注意中间件解析漏洞比如加上/xxx.asp/xxx.jpg

孤立页面分析：文件之间是有联系的 而webshell没有   其他可通过异常文件形式和流量检测

数据库分析

针对窃密型webshell 正常页面对数据库操作都是重复复杂的，而webshell是一次简单的还会有跨库查询   

先通过正常流量建立模型库 规划为白名单，后续不规范的统一告警处理    

统计学分析：针对混淆编码，工具NeoPI 原理很少有文件是会加密的，信息熵 编码越多 熵越大（每个字母出现的频率接近一样则可能为恶意），最长单词，重合指数（英文重合有规律，而混淆加密无 重合指数越低越有问题）  特征 通过已知的样本库     压缩比  把文件转化为二进制进行压缩，压缩比明文压缩比较多 而经过编码或加密混淆的文件压缩比较小

机器学习的检测：决策树 K近领 机器学习 神经网络  贝叶斯  随机森林 分类器  可以误报 但不能找不到

决策树：像法官断案，层层递进，根据特征做出决策
K近邻：邻家好坏决定自家好坏，靠的是距离
机器学习：数据中自学，不断优化预测模型
神经网络：模拟人脑，通过多层节点学习数据特征
贝叶斯算法：如同一个基于过往经验的推理者，不断更新对事物的看法。
随机森林：由多棵决策树组成，通过投票决定结果，抗噪性强
支持向量机（SVM）：在数据边界上画线，找到最佳分类超平面，进行黑白名单
神经网络：模拟人脑，通过多层节点学习数据特征

工具NeoPi（统计学检测）     findwebshell（传统特征＋云端）  牧云







## 电子取证与内存分析

![image-20240406143214626](C:\Users\西山\AppData\Roaming\Typora\typora-user-images\image-20240406143214626.png)

在应急中避免误操作而导致数据损耗和污染是应急人员基础素养，广义上来说以电子形式存储处理传输的信息都算电子数据，电子取证的目标是形成证据链  应急响应是为了恢复

**基本原则：授权，保证完整 真实 连续     		对象：终端 设备  无线**   

**易损失信息的提取**，一般通过命令行或Sysinternals工具 比如系统信息  网络连接  进程  日志 历史命令 文件

取证是一个复杂的过程，熟悉操作系统的内存管理机制、理解各种恶意软件的行为模式，并能够熟练使用内存分析工具

**取证过程中的关键是要保证证据的完整性和不可否认性**



### 活取证

**活取证** 目标是在不影响系统服务正常运行情况下，尽可能实时收集和分析数据  特征：实时 不中断业务  减少数据污染  但不全面会被发现

#### **隐蔽性计划**

1. 明确取证的目的，在攻击者不活跃的时间进行取证，使用加密通信SSH 端口复用或远程访问进去，若攻击者在转为被动流量收集，观察攻击者行为，隐蔽自己通道，同时在取证时候避免使用常见的工具enCase这种，将磁盘映像以只读方式挂载，以防止对数据的修改

实在不行的情况下 安装与服务器相同的操作系统，将服务器磁盘映像放虚拟机中进行分析（可以无限）

- **Volatility**：用于分析内存映像，查找恶意进程或敏感数据。
- **Bulk Extractor**：用于在磁盘映像中查找敏感信息，如社会安全号码或电子邮件地址。

#### **取证关键**

1. 内存镜像
2. 恶意样本  注册表  系统日志和事件 
3. 网络连接与进程   文件系统信息



#### 反入侵痕迹清理

取证之前挂上代理，减少流量，无感取证

Windows系统：

有远程桌面权限时手动删除日志：开始-程序-管理工具-计算机管理-系统工具-事件查看器-清除日志1。
使用wevtutil命令清理系统日志、应用程序日志和安全日志
使用clearev命令清除日志如果3389远程登录过，需要清除mstsc痕迹
执行命令清除日志：del %WINDR%\\* . log  /a/s/q/f
如果是web应用，找到web日志文件，删除



Linux系统

在获取权限后，不会记录输入过的命令：export HISTFILE=/dev/ null  export HISTSIZE= 
删除/var/log目录下的日志文件
如果是web应用，找到web日志文件，删除

- **清除操作日志**：在取证工作期间，清除您的操作日志，以防止被攻击者发现
- **避免留下痕迹**：避免在攻击者的日常日志中留下记录，例如Windows事件日志

举例分析： 假设您怀疑某员工泄露了公司的机密文件。

- 在深夜远程访问员工的工作站，获取磁盘映像
- 使用Volatility分析内存映像，查找可疑进程
- 清除您的操作日志，以避免被攻击者发现
- 使用自定义虚拟机环境进行分析

















### 死取证

**死取证**则是在系统已经停止运行或与网络隔离的状态下进行的取证活动，通常在系统遭受严重破坏或者已经无法正常运行时采用。特征：全面，但无法捕获实时数据，业务中断



#### 内存镜像

##### 基于内核模式程序提取

Dumpit提取，Volatility/Rediline分析 netscan 内存网络连接，psxview隐藏进程  malfind 隐藏DLL

##### 基于系统崩溃转储

系统属性——高级-----启动和故障恢复——设置——核心内存转储

##### 基于虚拟系统快照

vm esxi 生成

注：如果系统启用了休眠功能，可以将休眠文件作为内存镜像的来源

1. **内存镜像分析技术**：
   - **内存重组**：将内存镜像中的碎片数据重组，以重建文件系统、注册表和其他结构。
   - **内存沙箱**：在隔离的环境中运行内存镜像，以观察和记录恶意软件的行为。
   - **内存取证**：使用取证技术提取和分析内存中的数据，如密码、加密密钥和其他敏感信息
2. **内存镜像分析的自动化和脚本**：
   - **自动化脚本**：编写自动化脚本来快速执行常见的分析任务，如进程列表、网络连接和启动项的提取
   - **自定义插件**：为内存分析工具开发自定义插件，以支持新的文件格式、协议或恶意软件家族。
3. **内存镜像分析的挑战和对策**：
   - **加密和压缩**：处理加密或压缩的内存数据，可能需要解密密钥或压缩算法的知识。
   - **反取证技术**：攻击者可能使用反取证技术来隐藏其活动，需要使用先进的分析技术来检测这些痕迹
   - **大数据挑战**：内存镜像可能非常庞大，需要有效的数据处理和存储解决方案。







#### 磁盘复制

liunx的dd 二进制的物理复制 或使用商业工具SONIX

##### 磁盘克隆

  完整复制硬盘数据的方法，包括操作系统、程序、设置和用户数据

1. **准备目标硬盘**：确保目标硬盘的容量至少与源硬盘相同或更大
2. **使用克隆软件**：使用专门的硬盘克隆工具，如Clonezilla、Acronis True Image，这些工具能够创建硬盘的精确副本。
3. **启动克隆过程**：在启动克隆软件后，选择源硬盘和目标硬盘，然后开始克隆过程
4. **验证克隆结果**：克隆完成后，检查目标硬盘以确保所有数据都已成功复制

##### 磁盘镜像

创建硬盘的精确副本。与硬盘克隆不同，硬盘镜像会创建一个压缩的文件

1. **选择镜像软件**：使用支持镜像创建的工具，如Symantec Ghost、Macrium Reflect
2. **配置镜像参数**：在镜像软件中设置压缩级别、分割大小等参数，以优化镜像文件的大小和存储
3. **创建镜像文件**：执行镜像创建过程，软件将硬盘内容复制到一个或多个镜像文件中
4. **存储和备份**：将生成的镜像文件存储在安全的位置，如外部硬盘、网络存储设备或云存储服务

#### 文件复制

1. **选择文件和文件夹**：手动选择需要复制的文件和文件夹。
2. **使用文件复制工具**：可以使用操作系统自带的文件管理器（如Windows资源管理器或macOS Finder）进行复制粘贴操作，或者使用第三方文件同步和备份工具，如Robocopy、rsync等。
3. **执行复制操作**：将选定的文件和文件夹复制到目标位置，这可以是另一个硬盘、USB驱动器、网络共享或其他存储设备。

**注意：在复制过程中和复制后，使用哈希算法（如MD5、SHA-1或SHA-256）对数据进行校验，确保数据的完整性和一致性。**







## 威胁情报

### 威胁情报：

**详细定义**： 威胁情报的目的是为组织提供全面的安全视角，帮助它们构建更为精准的防御措施。

流程：

- **情报收集**：从多个来源收集情报，包括开源情报（OSINT）、商业威胁情报服务、行业共享平台和内部监控系统。
- **情报分析**：对收集到的原始数据进行分析，识别威胁模式、攻击向量和潜在的攻击场景。
- **情报共享**：与同行、监管机构和安全社区共享情报，以便更有效地应对跨组织的威胁。
- **情报应用**：将情报转化为具体的防御策略，如调整防火墙规则、更新入侵检测签名和培训员工识别钓鱼邮件。

**实际应用**：

- **威胁建模**：基于情报进行威胁建模，识别和评估组织的关键资产面临的潜在威胁。
- **风险评估**：利用情报进行风险评估，确定需要优先解决的安全问题。
- **安全策略制定**：根据情报更新和优化组织的安全策略和程序。

### 威胁猎杀：

**详细定义**： 威胁猎杀的目标是通过持续的监控和分析，识别并消除网络中的潜在威胁

**流程**：

- **威胁监测**：使监控工具和技术，如端点检测和响应（EDR）和用户行为分析（UBA），来监测网络和系统的异常行为。
- **威胁分析**：对监测到的可疑活动进行深入分析，以确定其是否为真正的威胁。
- **威胁消除**：一旦确认威胁，迅速采取措施进行隔离、清除和修复。
- **威胁追踪**：追踪威胁的来源和传播路径，以识别攻击者的策略、技术和程序（TTPs）。

**实际应用**：

- **红队与蓝队演练**：通过模拟攻击和防御演练，提高威胁猎杀团队的技能和响应能力。
- **自动化和人工智能**：利用自动化工具和AI技术，提高威胁猎杀的效率和准确性。
- **持续改进**：基于威胁猎杀的经验和结果，不断改进安全防御措施和响应流程。













































## 常见病毒与场景

### 僵尸病毒

**特征**：后门隐蔽，能进行自我复制传染，会被利用进行DDoS或挖矿等

**行为判断**：关注异常流量 如大量数据包发送不常见的目的地，异常进程 设备告警，系统性能下降 CPU或内存异常增高



### 木马病毒



**特征**：擅长伪装和欺骗，有后门，并进行窃取信息

**行为判断**：异常登录，可疑文件，开放了不必要的端口



### 蠕虫病毒

确立面  断网隔离  ACL  

熊猫烧香    冲击波  

**特征**：利用漏洞进行自我复制和传播，导致网络带宽消耗和系统资源紧张

**行为判断**：系统异常（频繁重启 缓慢 文件损失），网络连接异常



### 勒索病毒

知名：WannaCry   Stop    漏洞利用：Jboss反序列化 	Struts2RCE   RDP

**特征**：文件加密 不常见后缀名 勒索信息

**行为判断**：无法打开文件 扩展名被更改，有勒索信息

**解密：**1.入侵对方服务器，获取私钥解密  	2.逆向加密算法  	3.暴力破解私钥 	4.爆金币

注：1.别直插U盘 不然也会被感染	2.因勒索加密过程为 磁盘读取在内存进行加密，修改后的放回磁盘，反复读写容易损坏原始文件





### 挖矿病毒

知名：隐匿者  DDG  Watchdogs	漏洞利用：嵌入PE白进程，僵尸网络   非web框架/组件漏洞

**特征**：CPU  网络连接 矿池与矿卡

**行为判断**：系统使用率异常，发热严重 风扇加快

处理：1.阻止矿池地址连接		2.清除挖矿



第一个 

第二

第三



### DDOS与流量劫持

#### DDOS

1. **（流量型攻击）**：通过产生大量流量来耗尽目标网络的带宽。

2. **（协议型攻击）**：利用网络协议的缺陷，发送大量伪造的网络请求。

3. **（应用层攻击）**：针对特定应用层服务（如HTTP、DNS等）的攻击，模拟正常用户请求以耗尽资源

   消耗网络带宽

   ICMP UDP 使用大小包技术，造成延迟  常用目标  NTP   DNS响应比查询大 	SSDP物联网反射 SNMP设备

   消耗系统资源 TCP  SYN	消耗应用资源HTTP(GET POST)  慢速攻击 

**行为判断**：

- 服务器负载突然增加，合法用户无法访问服务。
- 网络流量分析显示大量异常或恶意流量模式。
- 多个用户报告无法访问网站或服务。



#### 流量劫持 

**特征**：控制与重定向流量，进行窃取或钓鱼

- 涉及到DNS欺骗、ARP欺骗、会话劫持

**分类**：反射与放大  慢速攻击  利用tcp协议三次连接 和ARP响应 以及DNS指向

1. **DNS劫持**：攻击者篡改DNS服务器的响应，使用户在访问正常网站时被重定向到恶意网站。
2. **ARP劫持**：攻击者在局域网内伪造ARP响应，使网络流量通过攻击者的设备，从而截获数据。
3. **SSL剥离**：攻击者利用SSL/TLS协议的弱点，强制客户端与服务器之间的通信降级到未加密的状态，以便窃取数据。

**行为判断**：

- 用户访问熟悉的网站时，突然被重定向到陌生的页面。
- 浏览器显示安全警告，提示SSL证书无效或过期。
- 网络流量监控显示有异常的重定向或大量的非正常流量。



###  网页篡改

**特征**：未授权的篡改，可能含有恶意链接或欺诈内容

**分类**：

1. **内容篡改**：攻击者更改网页上的文本、图片或视频内容，以传播错误信息或进行欺诈。
2. **代码注入**：网页中注入恶意代码，如JavaScript或HTML标签，用于盗取用户信息或进行其他恶意活动
3. **重定向攻击**：攻击者修改网页，使得用户在访问时被重定向到恶意网站，可能导致数据泄露或恶意软件感染

**行为判断**：

- 网站访问者报告网站内容异常，如页面显示不适当信息或被重定向到未知网站。
- 网站管理员在监控日志中发现未知的网页修改记录或未授权的登录尝试。
- 安全扫描工具报告网站存在跨站脚本（XSS）或其他常见的网页篡改漏洞。

技术：外挂轮询：用一个网页读取和检测的程序判断内容完整性   2：事件触发 使用操作系统的文件系统和接口 文件被修改则报警





### 数据泄露

**特征**：

- 数据泄露是指敏感数据未经授权地被访问、使用或披露
- 数据泄露可能涉及个人信息、财务数据、商业机密等。
- 泄露的数据可能被用于身份盗窃、欺诈、商业竞争

**分类**：

1. **个人身份信息泄露**：包括姓名、地址、电话号码、电子邮件地址、社会保险号码等。
2. **财务信息泄露**：涉及信用卡号码、银行账户信息、支付卡信息等。
3. **商业机密泄露**：包括研发计划、营销策略、客户数据等商业信息。

**行为判断**：

- 发现网络上有大量与公司相关的敏感信息，如在黑市、论坛或数据泄露网站上。
- 员工报告收到钓鱼邮件，邮件中含有公司内部文件或敏感数据。
- 安全监控系统发现异常访问模式，如非工作时间的数据访问请求。

2. 暗链排查

   定期检查网站的文件和目录，查找是否存在异常或未知的文件。   - 检查网站的源代码，查找是否存在恶意脚本或注入代码。

